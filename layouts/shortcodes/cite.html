{{/*
  Original: https://github.com/loup-brun/hugo-cite/blob/master/layouts/shortcodes/cite.html

  This file was copied and modified (simplified)

  Note: adding `-` in front of a reference only prints the title (e.g. {{< cite "-Singer1972" >}})

*/}}

{{- $errorMissingValue := "1 or 2 values must be supplied with this shortcode. You provided %d params. The first is required and should match an ID in the CSL-JSON bibliography file, the second is optional, and should be a page number or range of page numbers. Example: {{< cite \"Faure 1909\" \"304\" >}}" -}}
{{- $errorMissingNamedParams := "You must at least provide a citation key. It is required and should match an ID in the CSL-JSON bibliography file. Example: {{< cite key=\"Faure 1909\" >}}" -}}

{{- $defaultErrString := "No matching key was found for `%s` in the references. Please make sure to provide an available ID in your `bib.json` file." -}}

{{/* Set variables*/}}
{{- $key := "" -}}
{{- $keys := slice "" ";" -}}
{{- $pages := slice "" ";" -}}
{{- $keySeparator := ";" -}}

{{ $short := false }}

{{/* -------------------- Named/Positional Params -------------------- */}}
{{- if .IsNamedParams }}
  {{/* -------------------- (a) Named -------------------------------- */}}
  {{- if not (.Get "key") -}}
    {{- errorf $errorMissingNamedParams -}}
  {{- else -}}
    {{- $key = .Get "key" -}}
    {{- $pages = split (.Get "pages" | string) ";" -}}
  {{- end -}}
{{- else -}}
  {{/* -------------------- (b) Positional --------------------------- */}}
  {{- if lt (len .Params) 1 -}}
    {{- errorf $errorMissingValue (len .Params) -}}
  {{- else -}}
  {{- $key = (.Get 0) | replaceRE "^-(.+)" "$1" -}}
  {{ $keys = split $key $keySeparator -}}

  {{/*  grab the pages string  */}}
  {{- $pages = string (.Get 1) -}}

  {{/*  For short version of citation  */}}
  {{- if (findRE "^-(.+)" (.Get 0) 1) -}}
    {{ $short = true }}
  {{- end -}}
{{- end -}}

{{- $totalRefs := len $keys -}}


{{/* -------------------- BEGIN Bibliography path -------------------- */}}
{{- $bibliographyPath := "" }}

{{/* Default: check for a JSON file in the leaf bundle. */}}
{{- $pageResource := $.Page.Resources.GetMatch "*bib*.json" -}}
{{- if $pageResource }}
{{- $constructedBibResource := printf "content/%s%s" $.Page.File.Dir $pageResource.Name }}
{{- $bibliographyPath = $constructedBibResource }}
{{- end }}

{{- /* If a `bibFile` is specified in the page front-matter, it takes precedence
  over a page resource. */ -}}
{{- /* `specifiedBib` must be relative to project root */ -}}
{{- if $.Page.Params.bibFile }}
{{- $bibliographyPath = $.Page.Params.bibFile -}}
{{- end }}

{{- if gt (len $bibliographyPath) 0 -}}{{/* Begin Bibliography Loop */}}
{{- $bibliography := getJSON $bibliographyPath -}}
{{- /* -------------------- END Bibliography path -------------------- */ -}}

{{- range $keyIndex, $key := $keys -}}   {{- /* Range over citation keys */ -}}

  {{- range where $bibliography "id" "eq" $key -}}
    {{- $currentRef := . -}}

      {{/* Add to the collection of cited references */}}
      {{- $.Page.Scratch.SetInMap "citedBib" $key $currentRef -}}

      {{- $reference := . -}}


      {{ if $short }}
        <i>{{- $reference.title -}}</i> {{/* <---- !!! whenever a citation is prepended with `-` for "short" */}}
      {{ else }}
        {{ partial "bibliography/apa-style.html" $reference }} {{/* <----- !!! THE CITATION STRING OUTPUT !!! */}}
      {{ end }}

      {{/*  Below is only to add pages at the end of the reference  */}}
      {{ if $pages }}
        {{- $pages -}}
      {{- end -}}
      {{/*  End of inserting page numbers  */}}

      {{- if lt (add 1 $keyIndex) $totalRefs -}};&#32;{{- end -}}

      {{- else -}} {{- /* Did not find reference with matching key */ -}}
        {{- $particularKeyErr := printf $defaultErrString $key -}}
        {{- $errorNoMatchingKey := $particularKeyErr -}}
        <span style="background-color: #f00; color: #fff;">{{- $errorNoMatchingKey -}}</span>
      {{- end }}

    {{- end }}

  {{- end -}} {{/* End Bibliography Loop */ -}}

{{- end -}} {{- /* END loop over keys*/ -}}
